---
title: "NYC Mobility Sitrep"
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
params:
  date: "2020-03-31"
  install_packages: TRUE
---

```{r setup, include=FALSE}
if(params$install_packages) source('../src/dependencies.R')
knitr::opts_chunk$set(echo = FALSE)
library(tidyr)
library(dplyr)
library(magrittr)
```

```{r, echo = F}
paste("Updated on",Sys.time())
```

# Reading Guide
## Data

All figures in this report are generated using movement data generated by Facebook. These data represent people who use Facebook in this region and have location services enabled. Data are aggregated at a 600m x 600m sized tiles and vectors (lines) are drawn connecting all areas to each other. These lines provide data in both directions (going from area A to B and from area B to A) We are provided:

1) The starting point of each line
2) The ending point of each line
3) The number of people who traveled along this line in both directions for the 45 days preceeding the collection of the data (noted on the bottom of every set of figures)
4) The number of people who traveled along this line in both directions for a given time period.
5) The length of the line in euclidean distance (as the crow flies, not through the existing travel network).
8) Data are aggregated in 8 hour blocks, one of these blocks for NYC is from 2100 to 0500. We treat this as belonging to the date that 2100 is in.

## Figures - NYC Level
**Percent Change in Travel Map** - The percent change in travel within and between NTA's in NYC. It is important to note here that some NTAs show up in one map and not the other. As people stop moving, and especially if they don't leave their homes, they no longer contribute to FB movement data so we are unable to capture any information from them.

**Percent change in total number of trips compared to baseline** - The total number of trips originating and ending in the region for which we have data minus the average number of trips originating from the same area for the 45 days preceding the start of data collection.

**Total distance traveled** - The total distance of trips originating and ending in the region for which we have data.

## Figures - NTA Level
**Local Travel Network** - A map of the region for which we have data showing the top locations of travel to and from that NTA.

**Percent change in total number of trips compared to baseline** - The total number of trips originating and ending in the region for which we have data minus the average number of trips originating from the same area for the 45 days preceding the start of data collection.

**Total distance traveled** - The total distance of trips originating and ending in the region for which we have data.

## Pointers on evaluating the data

- It's best to look at percent change in trips and total distance traveled as two views of a "mobility" metric. For example, if the number of trips goes up but the total distance traveled goes down, it likely means that people are moving a bit more but mainly going shorter distances, perhaps even just exercising or walking around the neighborhood.
- When looking at the travel network remember that people will live at boundaries of the area of interest, therefore, it may just be short distance movements that are resulting in people traveling from one location to another. Long distance travel connections are more difficult to rationalize and warrant further investigation.
- You'll often see an uptick in movement and total distance traveled on the weekends. This is generally normal behavior, though deviation from this during lock down measures should be evaluated.
- Keep an eye on the Y axis, it may be log scaled to better show the data. The labels are correct but rates of change are more extreme than they appear.

## Key Takeaways
- The uptick in movement has generally leveled off. There are some new travel patterns for the regions with most travel that should be evaluated to ensure that the networks make sense and are expected.


# NYC Summary


```{r echo = FALSE}

knitr::include_graphics(paste0("../figs/NYC/",params$date,"/city/NYC.png"))

```

# NTA Specific Analysis

```{r tidyr, dplyr, magrittr, echo = FALSE, results = "asis", strip.white= FALSE}

figs <- dir(paste0("../figs/NYC/",params$date,"/nta/"))

data.frame("fig_name" = figs) %>%
  separate(fig_name, c("count", "borough", "image"), sep = " - ", remove = F) %>%
  mutate(nta = gsub("*?\\.png$", "", image),
         fig_path = paste0("../figs/NYC/",params$date,"/nta/", fig_name),
         count = as.integer(count)) %>%
  arrange(-count, borough) %>%
  mutate(section = cut(count,
                       breaks = c(0,quantile(count, c(0.333,0.666,1))),
                       labels = c("Least Travel", "Medium Travel", "Most Travel"), include.lowest = T)) -> out



template_size <- "
## %s

"

template_borough <- "
---

### %s



"

template_nta <- "
---

#### %s


![](%s)

---

"

# dont't forget the newline

for(i in seq(length(unique(out$section)))){
  in_section <- unique(out$section)[i]
  #subset data
  sub_data <- subset(out, section == in_section)
  #print borough header
  cat(sprintf(template_size, in_section))

  #print images for ntas
  for(j in seq(length(unique(sub_data$borough)))){
    in_borough <- unique(sub_data$borough)[j]


    nta_data <- subset(sub_data, borough == in_borough)

    cat(sprintf(template_borough, in_borough))

    #print NTA
    for(k in seq(length(unique(nta_data$nta)))){
      cat(sprintf(template_nta, nta_data[k, "nta"], nta_data[k, "fig_path"]))
    }

  }


}
```
